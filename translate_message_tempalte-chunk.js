var m=Object.defineProperty;var f=(n,t,s)=>t in n?m(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var l=(n,t,s)=>f(n,typeof t!="symbol"?t+"":t,s);function y(n){if(!n)return!1;const t=n instanceof Headers?n.get("content-type"):n["content-type"]??n["Content-Type"];return!!t&&t.includes("application/json")}class E{constructor(t,s,e,a={}){l(this,"url");l(this,"opts");l(this,"callbacks");l(this,"controller",null);l(this,"running",!1);l(this,"attempts",0);this.url=t,this.opts={model:e.model,method:"POST",stream:e.stream,reconnect:{maxAttempts:5,delayMs:1e3,backoff:!0},headers:{Authorization:s,"Content-Type":"application/json"},body:{messages:e.messages}},this.callbacks=a}async wait(t){return new Promise(s=>setTimeout(s,t))}isRunning(){return this.running}stop(){var t;(t=this.controller)==null||t.abort(),this.running=!1}async start(){var s,e,a,c;if(this.running)throw new Error("SSEPost already running");this.running=!0,this.attempts=0;const t=this.opts.reconnect;for(;this.running;)try{this.attempts++,await this.openOnce();break}catch(o){if((e=(s=this.callbacks).onError)==null||e.call(s,o),!this.running)break;if(this.attempts>=(t.maxAttempts??0)){this.running=!1;break}const u=t.delayMs??1e3,i=t.backoff?u*Math.pow(2,this.attempts-1):u;await this.wait(i)}(c=(a=this.callbacks).onClose)==null||c.call(a),this.running=!1}async openOnce(){var c,o,u,i;this.controller=new AbortController;const t=this.opts.signal;t&&(t.aborted?this.controller.abort():t.addEventListener("abort",()=>{var r;return(r=this.controller)==null?void 0:r.abort()},{once:!0}));const s=new Headers(this.opts.headers);let e;if(this.opts.body!=null){if(typeof this.opts.body=="object"&&!(this.opts.body instanceof FormData)){if(this.opts.model)this.opts.body.model=this.opts.model;else throw new Error("Request failed: no model specified. Please provide a valid 'model' parameter before making a request.");this.opts.body.stream===void 0?this.opts.body={...this.opts.body,stream:this.opts.stream??!0}:this.opts.body.stream=this.opts.stream??!0}y(this.opts.headers)?e=JSON.stringify(this.opts.body):typeof this.opts.body=="string"||this.opts.body instanceof FormData?e=this.opts.body:(s.set("Content-Type","application/json"),e=JSON.stringify(this.opts.body))}const a=await fetch(this.url,{method:this.opts.method,headers:s,body:e,signal:this.controller.signal});if(!a.ok){const r=await b(a);throw new Error(`SSE POST failed: ${a.status} ${a.statusText} - ${r}`)}if((o=(c=this.callbacks).onOpen)==null||o.call(c,a),!this.opts.stream){const r=await a.text();(i=(u=this.callbacks).onEvent)==null||i.call(u,{data:r});return}a.body&&await this.readStream(a.body.getReader())}async readStream(t){const s=new TextDecoder("utf-8");let e="";const a=this.opts.chunkDelimiter??`

`,c=o=>{var i,r;const u=o.split(a);for(let p of u){if(p=p.trim(),!p)continue;const h=this.parseEvent(p);h&&((r=(i=this.callbacks).onEvent)==null||r.call(i,h))}};try{for(;;){const{value:o,done:u}=await t.read();if(u)break;e+=s.decode(o,{stream:!0});const i=e.split(a);for(let r=0;r<i.length-1;r++){const p=i[r];c(p+a)}e=i[i.length-1]}e.trim()&&c(e)}catch(o){if(o.name==="AbortError")return;throw o}}parseEvent(t){const s=t.split(/\r?\n/);let e=[],a;for(const o of s)o.startsWith("id:")?a=o.slice(3).trim():o.startsWith("data:")&&e.push(o.slice(5).replace(/^\s?/,""));if(e.length===0)return null;const c=e.join(`
`);return{id:a,data:c}}}async function b(n){try{return await n.text()}catch{return"<no body>"}}class C{constructor(t,s,e){l(this,"model");l(this,"template");l(this,"stream");this.model=t,this.template=s,this.stream=e}getPrompt(t){return{model:this.model,temperature:0,messages:this.template.getMessages(t),stream:this.stream}}}function d(n,t){return JSON.stringify(n,null,2).replace(/\$\{target_language\}/g,t)}function w(n,t){const s=[g.identity,"RULES:",...g.instructions.map(e=>(e=e.replace("${single_word_output_template}",d(T,n)),e=e.replace("${sentence_or_phrase_output_template}",d(S,n)),e=e.replace("${target_language}",n),e))];return t&&(s.push("CONTEXT:"),s.push(t)),s.join(` 
`)}function _(n){return x.replace("${content_to_translate}",n)}class O{constructor(t){l(this,"targetLanguage");this.targetLanguage=t}getMessages(t,s){return[{role:"system",content:w(this.targetLanguage,s)},{role:"user",content:_(t)}]}}const g={identity:"You are a professional multilingual translation engine.",instructions:["1. For single words: provide translation, phonetics, definitions grouped by part of speech, and example sentences.","2. For sentences/phrases (i.e., multi-word expressions or sentences containing spaces, punctuation, or more than one word in the detected language): provide translation only.","3. All responses must be in ${target_language}.","4. For English source text, use American phonetics for phonetic symbols.","5. For Chinese source text, use standard Pinyin with tone marks for phonetic symbols.","6. For other source languages, use their native phonetic systems for phonetic symbols.","7. Do not output languages other than those requested","8. Consider context when analyzing words.","9. Output raw JSON without markdown code blocks.","10. Ensure all textual content (translations, definitions, examples, etc.) is written strictly in the explicitly specified target language.","11. For languages such as Chinese, Japanese, Korean, or Thai — where a single semantic word may consist of multiple characters — treat any input that represents one semantic unit (i.e., conveys a single idea or concept) as a single word, and follow Rule 1.","SINGLE WORD OUTPUT:","${single_word_output_template}","SENTENCE/PHRASE OUTPUT:","${sentence_or_phrase_output_template}"]},T={detected_language:"en-US",translation:"translation in ${target_language}",phonetic:"/həˈləʊ/",definitions:[{pos:"excl.",meaning:"${target_language} translation for current pos",example:{source:"A natural example sentence written in source language, accurately showing this sense of the word.",target:"The same example translated into ${target_language}."}}],contextual_analysis:"Provide a contextual analysis written strictly in ${target_language}, while allowing keywords and nonessential elements to remain in the source language."},S={detected_language:"en-US",translation:"translation in ${target_language}"},x='【Content to Translate】: "${content_to_translate}"';export{C as P,E as S,O as T};
