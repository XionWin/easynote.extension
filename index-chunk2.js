function x(i,e){i.indexOf(e)===-1&&i.push(e)}function b(i,e){const t=i.indexOf(e);t>-1&&i.splice(t,1)}const y={},R=i=>i;class U{constructor(){this.subscriptions=[]}add(e){return x(this.subscriptions,e),()=>b(this.subscriptions,e)}notify(e,t,n){const s=this.subscriptions.length;if(s)if(s===1)this.subscriptions[0](e,t,n);else for(let o=0;o<s;o++){const a=this.subscriptions[o];a&&a(e,t,n)}}getSize(){return this.subscriptions.length}clear(){this.subscriptions.length=0}}function N(i,e){return e?i*(1e3/e):0}const f=["setup","read","resolveKeyframes","preUpdate","update","preRender","render","postRender"];function q(i,e){let t=new Set,n=new Set,s=!1,o=!1;const a=new WeakSet;let d={delta:0,timestamp:0,isProcessing:!1};function v(r){a.has(r)&&(u.schedule(r),i()),r(d)}const u={schedule:(r,g=!1,A=!1)=>{const p=A&&s?t:n;return g&&a.add(r),p.has(r)||p.add(r),r},cancel:r=>{n.delete(r),a.delete(r)},process:r=>{if(d=r,s){o=!0;return}s=!0,[t,n]=[n,t],t.forEach(v),t.clear(),s=!1,o&&(o=!1,u.process(r))}};return u}const D=40;function L(i,e){let t=!1,n=!0;const s={delta:0,timestamp:0,isProcessing:!1},o=()=>t=!0,a=f.reduce((c,h)=>(c[h]=q(o),c),{}),{setup:d,read:v,resolveKeyframes:u,preUpdate:r,update:g,preRender:A,render:F,postRender:p}=a,w=()=>{const c=y.useManualTiming?s.timestamp:performance.now();t=!1,y.useManualTiming||(s.delta=n?1e3/60:Math.max(Math.min(c-s.timestamp,D),1)),s.timestamp=c,s.isProcessing=!0,d.process(s),v.process(s),u.process(s),r.process(s),g.process(s),A.process(s),F.process(s),p.process(s),s.isProcessing=!1,t&&e&&(n=!1,i(w))},T=()=>{t=!0,n=!0,s.isProcessing||i(w)};return{schedule:f.reduce((c,h)=>{const C=a[h];return c[h]=(E,M=!1,S=!1)=>(t||T(),C.schedule(E,M,S)),c},{}),cancel:c=>{for(let h=0;h<f.length;h++)a[f[h]].cancel(c)},state:s,steps:a}}const{schedule:O,cancel:j,state:P}=L(typeof requestAnimationFrame<"u"?requestAnimationFrame:R,!0);let l;function I(){l=void 0}const m={now:()=>(l===void 0&&m.set(P.isProcessing||y.useManualTiming?P.timestamp:performance.now()),l),set:i=>{l=i,queueMicrotask(I)}},V=30,K=i=>!isNaN(parseFloat(i));class z{constructor(e,t={}){this.canTrackVelocity=null,this.events={},this.updateAndNotify=n=>{var o;const s=m.now();if(this.updatedAt!==s&&this.setPrevFrameValue(),this.prev=this.current,this.setCurrent(n),this.current!==this.prev&&((o=this.events.change)==null||o.notify(this.current),this.dependents))for(const a of this.dependents)a.dirty()},this.hasAnimated=!1,this.setCurrent(e),this.owner=t.owner}setCurrent(e){this.current=e,this.updatedAt=m.now(),this.canTrackVelocity===null&&e!==void 0&&(this.canTrackVelocity=K(this.current))}setPrevFrameValue(e=this.current){this.prevFrameValue=e,this.prevUpdatedAt=this.updatedAt}onChange(e){return this.on("change",e)}on(e,t){this.events[e]||(this.events[e]=new U);const n=this.events[e].add(t);return e==="change"?()=>{n(),O.read(()=>{this.events.change.getSize()||this.stop()})}:n}clearListeners(){for(const e in this.events)this.events[e].clear()}attach(e,t){this.passiveEffect=e,this.stopPassiveEffect=t}set(e){this.passiveEffect?this.passiveEffect(e,this.updateAndNotify):this.updateAndNotify(e)}setWithVelocity(e,t,n){this.set(t),this.prev=void 0,this.prevFrameValue=e,this.prevUpdatedAt=this.updatedAt-n}jump(e,t=!0){this.updateAndNotify(e),this.prev=e,this.prevUpdatedAt=this.prevFrameValue=void 0,t&&this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}dirty(){var e;(e=this.events.change)==null||e.notify(this.current)}addDependent(e){this.dependents||(this.dependents=new Set),this.dependents.add(e)}removeDependent(e){this.dependents&&this.dependents.delete(e)}get(){return this.current}getPrevious(){return this.prev}getVelocity(){const e=m.now();if(!this.canTrackVelocity||this.prevFrameValue===void 0||e-this.updatedAt>V)return 0;const t=Math.min(this.updatedAt-this.prevUpdatedAt,V);return N(parseFloat(this.current)-parseFloat(this.prevFrameValue),t)}start(e){return this.stop(),new Promise(t=>{this.hasAnimated=!0,this.animation=e(t),this.events.animationStart&&this.events.animationStart.notify()}).then(()=>{this.events.animationComplete&&this.events.animationComplete.notify(),this.clearAnimation()})}stop(){this.animation&&(this.animation.stop(),this.events.animationCancel&&this.events.animationCancel.notify()),this.clearAnimation()}isAnimating(){return!!this.animation}clearAnimation(){delete this.animation}destroy(){var e,t;(e=this.dependents)==null||e.clear(),(t=this.events.destroy)==null||t.notify(),this.clearListeners(),this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}}function k(i,e){return new z(i,e)}export{z as M,U as S,P as a,y as b,j as c,L as d,O as f,k as m,R as n,m as t,N as v};
